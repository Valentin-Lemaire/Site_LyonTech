<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Lyon Tech</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700&family=Roboto:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../main.css">
    <script>
        (function () {
            const params = new URLSearchParams(window.location.search);
            const theme = params.get('theme') || localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                try { localStorage.setItem('theme', 'dark'); } catch (e) { }
            }
        })();
    </script>
    <style>
        .admin-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: var(--bg-surface);
            border-right: 1px solid var(--border-glass);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.02);
            z-index: 10;
        }

        .sidebar-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--text-main) 0%, var(--primary-color) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
            padding-left: 0.5rem;
        }

        .nav-item {
            padding: 0.85rem 1rem;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            font-size: 1rem;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: rgba(var(--h-primary), var(--s-primary), var(--l-primary), 0.05);
            color: var(--primary-color);
            transform: translateX(3px);
        }

        .nav-item.active {
            background: rgba(var(--h-primary), var(--s-primary), var(--l-primary), 0.1);
            color: var(--primary-color);
            font-weight: 600;
            border-color: rgba(var(--h-primary), var(--s-primary), var(--l-primary), 0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th {
            text-align: left;
            padding: 1.25rem 1.5rem;
            color: var(--text-muted);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            border-bottom: 2px solid rgba(0, 0, 0, 0.03);
        }

        .data-table td {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
            vertical-align: middle;
            color: var(--text-main);
            transition: background 0.2s;
        }

        .data-table tr:hover td {
            background: rgba(var(--h-primary), var(--s-primary), var(--l-primary), 0.02);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-en-cours {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }

        .status-termine {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        /* Team Badges */
        .cat-bureau {
            background: rgba(139, 92, 246, 0.1);
            color: #7c3aed;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .cat-responsable {
            background: rgba(234, 179, 8, 0.1);
            color: #ca8a04;
            border: 1px solid rgba(234, 179, 8, 0.2);
        }

        .cat-membre {
            background: rgba(100, 116, 139, 0.1);
            color: #475569;
            border: 1px solid rgba(100, 116, 139, 0.2);
        }

        .actions-cell {
            display: flex;
            gap: 0.5rem;
        }

        .admin-content {
            padding: 3rem 4rem;
            /* Increased spacing */
            overflow-y: auto;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-muted);
            background: transparent;
        }

        .action-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-main);
        }

        .btn-edit:hover {
            color: #2563eb;
            background: rgba(59, 130, 246, 0.1);
        }

        .btn-delete:hover {
            color: #dc2626;
            background: rgba(220, 38, 38, 0.1);
        }

        .action-icon {
            width: 18px;
            height: 18px;
            stroke-width: 2;
        }

        .tabs {
            display: none;
        }

        .tabs.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
            fill: none;
            stroke: currentColor;
        }

        .btn-logout {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(239, 68, 68, 0.05);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.1);
            padding: 0.85rem 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            margin-top: auto;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .btn-logout:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-body);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.5s;
        }

        /* Fix Button Visibility in Dark Mode (SCSS override) */
        .btn-secondary {
            background: rgba(var(--h-primary), var(--s-primary), var(--l-primary), 0.1);
            color: var(--text-main) !important;
            border: 1px solid var(--border-glass);
            padding: 0.875rem 1.5rem;
            border-radius: 9999px;
            cursor: pointer;
            font-weight: 700;
            font-family: inherit;
        }

        .btn-secondary:hover {
            background: rgba(var(--h-primary), var(--s-primary), var(--l-primary), 0.2);
            color: var(--primary-color) !important;
            border-color: var(--primary-color);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(23, 66, 94, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.open {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: var(--bg-surface);
            padding: 2rem;
            border-radius: 1rem;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(20px);
            transition: transform 0.3s ease;
            position: relative;
        }

        .modal.open .modal-content {
            transform: translateY(0);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-glass);
            border-radius: 0.5rem;
            background: var(--bg-body);
            color: var(--text-main);
            font-family: inherit;
            margin-bottom: 0.5rem;
        }

        .member-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            background: #eee;
            margin-right: 10px;
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="admin-layout" style="opacity: 0; transition: opacity 0.5s;">
        <aside class="sidebar">
            <div class="sidebar-title">Lyon Tech Admin</div>
            <nav style="flex-grow: 1;">
                <a class="nav-item active" data-tab="messages">
                    <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    Messages
                </a>
                <a class="nav-item" data-tab="projects">
                    <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                    </svg>
                    Projets
                </a>
                <a class="nav-item" data-tab="team">
                    <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    √âquipe
                </a>
                <a class="nav-item" data-tab="settings">
                    <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg>
                    Param√®tres
                </a>
            </nav>
            <div style="margin-top: auto; display: flex; flex-direction: column; gap: 0.5rem;">
                <button id="themeToggleBtn" class="nav-item"
                    style="justify-content: flex-start; background: transparent; border: 1px solid var(--border-glass);">
                    <span id="themeIcon" style="display:flex;"></span>
                    <span id="themeText">Mode Sombre</span>
                </button>
                <button id="logoutBtn" class="btn-logout">
                    <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    D√©connexion
                </button>
            </div>
        </aside>

        <main class="admin-content">
            <div class="header-bar">
                <h1 id="pageTitle">Messages Re√ßus</h1>
                <!-- Le bouton d'action principal chang√© dynamiquement -->
                <button id="mainActionBtn" class="btn btn-primary" style="display: none;">
                    Action
                </button>
            </div>

            <!-- TAB 1: Messages -->
            <div id="messages" class="tabs active">
                <div class="content-card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>Sujet</th>
                                <th style="text-align:right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="messagesTableBody">
                            <tr>
                                <td colspan="5">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 2: Projets -->
            <div id="projects" class="tabs">
                <div class="content-card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Titre</th>
                                <th>Statut</th>
                                <th>Technologies</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <tr>
                                <td colspan="4">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 3: √âquipe -->
            <div id="team" class="tabs">
                <div class="content-card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Membre</th>
                                <th>R√¥le (Hi√©rarchie)</th>
                                <th>LinkedIn</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="teamTableBody">
                            <tr>
                                <td colspan="4">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 4: Param√®tres -->
            <div id="settings" class="tabs">
                <div style="display:grid; gap:2rem; max-width:600px;">
                    <!-- Email Update -->
                    <div class="content-card">
                        <h2
                            style="margin-bottom:1rem; border-bottom:1px solid var(--border-glass); padding-bottom:0.5rem;">
                            Modifier l'Email</h2>
                        <form id="emailForm" style="display:flex; flex-direction:column; gap:1rem;">
                            <div>
                                <label style="display:block; margin-bottom:0.5rem; color:var(--text-muted);">Nouvelle
                                    adresse Email</label>
                                <input type="email" id="newEmail" class="form-input" required
                                    placeholder="nouveau@email.com">
                            </div>
                            <button type="submit" class="btn btn-primary">Mettre √† jour l'Email</button>
                        </form>
                    </div>

                    <!-- Password Update -->
                    <div class="content-card">
                        <h2
                            style="margin-bottom:1rem; border-bottom:1px solid var(--border-glass); padding-bottom:0.5rem;">
                            Modifier le Mot de Passe</h2>
                        <form id="passwordForm" style="display:flex; flex-direction:column; gap:1rem;">
                            <div>
                                <label style="display:block; margin-bottom:0.5rem; color:var(--text-muted);">Nouveau Mot
                                    de Passe</label>
                                <input type="password" id="newPassword" class="form-input" required minlength="6"
                                    placeholder="******">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:0.5rem; color:var(--text-muted);">Confirmer
                                    le Mot de Passe</label>
                                <input type="password" id="confirmPassword" class="form-input" required minlength="6"
                                    placeholder="******">
                            </div>
                            <button type="submit" class="btn btn-primary">Mettre √† jour le Mot de Passe</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL 1: Projet -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <h2>Ajouter/Modifier un Projet</h2>
            <form id="projectForm" style="display: flex; flex-direction: column; gap: 1rem;">
                <input type="hidden" id="projectId">
                <input type="text" id="projectTitle" placeholder="Titre du projet" class="form-input" required>
                <select id="projectStatus" class="form-input">
                    <option value="en-cours">En cours</option>
                    <option value="termine">Termin√©</option>
                </select>
                <input type="text" id="projectImage" placeholder="URL de l'image (ex: https://...)" class="form-input">
                <input type="text" id="projectTech" placeholder="Technologies" class="form-input">
                <textarea id="projectDesc" placeholder="Description" class="form-input" rows="4"></textarea>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('projectModal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL 2: √âquipe -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <h2>Membre de l'√âquipe</h2>
            <form id="teamForm" style="display: flex; flex-direction: column; gap: 1rem;">
                <input type="hidden" id="memberId">
                <input type="text" id="memberName" placeholder="Nom complet" class="form-input" required>
                <!-- Hi√©rarchie -->
                <label style="font-size:0.9em; color:var(--text-muted); margin-bottom:-0.25rem;">Niveau
                    Hi√©rarchique</label>
                <select id="memberCategory" class="form-input" required>
                    <option value="bureau">Bureau (Pr√©sident, Tr√©sorier...)</option>
                    <option value="responsable">Responsable P√¥le/Projet</option>
                    <option value="membre">Membre Actif</option>
                </select>
                <input type="text" id="memberRole" placeholder="Titre exact (ex: Pr√©sident, Dev Frontend...)"
                    class="form-input" required>
                <input type="text" id="memberImage" placeholder="URL Photo Profil (ex: https://...)" class="form-input">
                <input type="text" id="memberLinkedin" placeholder="Lien LinkedIn" class="form-input">

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('teamModal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL 3: D√©tail Message -->
    <div id="messageModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-glass); padding-bottom: 1rem;">
                D√©tail du Message</h2>
            <div id="msgDetailContent" style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Rempli par JS -->
            </div>
            <div style="margin-top: 2rem; text-align: right;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('messageModal')">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // --- CONFIG & INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyBRnfU9g641yhKsjGXxbV_KbzRN3whfa1M",
            authDomain: "site-lyon-tech.firebaseapp.com",
            projectId: "site-lyon-tech",
            storageBucket: "site-lyon-tech.firebasestorage.app",
            messagingSenderId: "382756341988",
            appId: "1:382756341988:web:189cf01cb7819764a1c4f1",
            measurementId: "G-HHNHXMTZ75"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- AUTH ---
        auth.onAuthStateChanged((user) => {
            document.getElementById('loadingOverlay').style.display = 'none';
            if (user) {
                document.querySelector('.admin-layout').style.opacity = '1';
                loadMessages(); // Default load
            } else {
                window.location.href = 'login.html';
            }
        });
        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());

        // --- THEME TOGGLE (Admin) ---
        const themeBtn = document.getElementById('themeToggleBtn');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');

        function updateThemeUI() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            themeIcon.innerHTML = isDark
                ? '<svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>' // Sun
                : '<svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>'; // Moon
            themeText.textContent = isDark ? 'Mode Clair' : 'Mode Sombre';
        }

        // Init UI
        updateThemeUI();

        if (themeBtn) {
            themeBtn.addEventListener('click', () => {
                const current = document.documentElement.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
                updateThemeUI();

                const newUrl = new URL(window.location);
                newUrl.searchParams.set('theme', next);
                window.history.replaceState({}, '', newUrl);
            });
        }

        // --- NAVIGATION TABS ---
        const tabs = document.querySelectorAll('.nav-item[data-tab]');
        const mainBtn = document.getElementById('mainActionBtn');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // UI Update
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.tabs').forEach(t => t.classList.remove('active'));
                const tabId = tab.dataset.tab;
                document.getElementById(tabId).classList.add('active');

                // Titles & Buttons
                const titleMap = {
                    'messages': 'Messages Re√ßus',
                    'projects': 'Gestion des Projets',
                    'team': 'Gestion de l\'√âquipe',
                    'settings': 'Param√®tres du Compte'
                };
                document.getElementById('pageTitle').textContent = titleMap[tabId];

                // Button Logic
                mainBtn.style.display = 'none';
                mainBtn.onclick = null;

                if (tabId === 'messages') loadMessages();

                if (tabId === 'projects') {
                    loadProjects();
                    mainBtn.style.display = 'inline-block';
                    mainBtn.innerHTML = '<span style="font-size:1.2em; margin-right:8px; line-height:1;">+</span> Ajouter un Projet';
                    mainBtn.onclick = openProjectModal; // Create Mode
                }

                if (tabId === 'team') {
                    loadTeam();
                    mainBtn.style.display = 'inline-block';
                    mainBtn.innerHTML = '<span style="font-size:1.2em; margin-right:8px; line-height:1;">+</span> Ajouter un Membre';
                    mainBtn.onclick = openTeamModal; // Create Mode
                }
            });
        });

        // --- HELPERS ---
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('open');
        }

        // --- ERROR HANDLING HELPER ---
        function getErrorMessage(error) {
            console.error("Firebase Error:", error); // Keep technical log for debugging
            switch (error.code) {
                case 'auth/requires-recent-login':
                    return "Par s√©curit√©, cette action n√©cessite une connexion r√©cente.\nVeuillez vous d√©connecter et vous reconnecter, puis r√©essayez.";
                case 'auth/weak-password':
                    return "Le mot de passe est trop faible. Il doit contenir au moins 6 caract√®res.";
                case 'auth/email-already-in-use':
                    return "Cette adresse email est d√©j√† utilis√©e par un autre compte.";
                case 'auth/invalid-email':
                    return "L'adresse email saisie n'est pas valide.";
                case 'auth/operation-not-allowed':
                    return "Cette op√©ration n'est pas activ√©e dans la configuration Firebase.";
                case 'auth/user-token-expired':
                    return "Votre session a expir√©. Veuillez vous reconnecter.";
                case 'permission-denied':
                    return "Acc√®s refus√©. Vous n'avez pas les droits suffisants.";
                case 'unavailable':
                    return "Le service est temporairement indisponible. V√©rifiez votre connexion.";
                default:
                    return "Une erreur est survenue : " + error.message;
            }
        }

        // --- SETTINGS LOGIC ---
        document.getElementById('emailForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newEmail = document.getElementById('newEmail').value;
            const user = auth.currentUser;
            if (user) {
                user.verifyBeforeUpdateEmail(newEmail).then(() => {
                    alert('Un email de v√©rification a √©t√© envoy√© √† ' + newEmail + '.\nVeuillez cliquer sur le lien dans cet email pour valider le changement.');
                }).catch((error) => {
                    alert(getErrorMessage(error));
                });
            }
        });

        document.getElementById('passwordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;

            if (newPass !== confirmPass) {
                alert('Les deux mots de passe ne correspondent pas.');
                return;
            }

            const user = auth.currentUser;
            if (user) {
                user.updatePassword(newPass).then(() => {
                    alert('Mot de passe mis √† jour avec succ√®s !');
                    document.getElementById('passwordForm').reset();
                }).catch((error) => {
                    alert(getErrorMessage(error));
                });
            }
        });

        // --- REST OF THE LOGIC (Messages, Projects, Team) remains below ---
        // (Just keeping the structure consistent with previous rewrites)

        // --- MESSAGES LOGIC ---
        function loadMessages() {
            const tbody = document.getElementById('messagesTableBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Chargement...</td></tr>';
            db.collection("contacts").orderBy("timestamp", "desc").get().then((snap) => {
                tbody.innerHTML = '';
                if (snap.empty) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Aucun message.</td></tr>'; return; }
                snap.forEach(doc => {
                    const d = doc.data();
                    const isRead = d.read === true; // Default false if undefined
                    const date = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleDateString() : '-';
                    const safeName = (d.name || 'Anonyme').replace(/'/g, "\\'");
                    const safeEmail = (d.email || '-').replace(/'/g, "\\'");
                    const safeSubject = (d.subject || 'Sans sujet').replace(/'/g, "\\'");
                    const safeMessage = (d.message || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;").replace(/\n/g, "<br>");

                    // Visual Read/Unread State
                    let statusHtml = '';
                    if (d.readBy) {
                        // Extract name from email for shorter display (e.g. "ramadane" from "ramadane@...")
                        const reader = d.readBy.split('@')[0];
                        statusHtml = `<span style="color:#9ca3af; font-size:0.8em; display:block;">Lu par ${reader}</span>`;
                    } else if (d.read) {
                        // Legacy support for messages marked read before this feature
                        statusHtml = '<span style="color:#9ca3af; font-size:0.8em;">Lu</span>';
                    } else {
                        statusHtml = '<span style="color:var(--primary-color); font-size:0.8em;">‚óè Nouveau</span>';
                    }

                    const isUnread = !d.read && !d.readBy;

                    tbody.innerHTML += `
                        <tr id="row-${doc.id}" style="${isUnread ? 'font-weight:600; background:rgba(var(--h-primary), var(--s-primary), var(--l-primary), 0.05);' : ''}">
                            <td style="white-space:nowrap; color:var(--text-muted); font-size:0.9em;">${date}</td>
                            <td>
                                ${d.name || 'Anonyme'}
                                ${statusHtml}
                            </td>
                            <td>${d.email || '-'}</td>
                            <td>${d.subject || 'Sans sujet'}</td>
                            <td style="text-align:right;">
                                <button class="action-btn" onclick="viewMessage('${doc.id}', '${date}', '${safeName}', '${safeEmail}', '${safeSubject}', '${safeMessage}')" title="Lire le message">
                                    <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                </button>
                            </td>
                        </tr>`;
                });
            });
        }
        function viewMessage(id, date, name, email, subject, message) {
            const user = auth.currentUser;
            const userEmail = user ? user.email : 'Admin';

            // Mark as read in DB if not already read (or if we want to update who read it last? let's stick to first reader logic, or overwrite. Overwriting is simpler for now to confirm "I saw it")
            // Actually, usually we keep the FIRST reader. Let's check UI row.
            const row = document.getElementById(`row-${id}`);

            // If currently unread (bold), mark it
            if (row && row.style.fontWeight === '600') {
                // Update UI immediately
                row.style.fontWeight = 'normal';
                row.style.background = 'transparent';

                const nameCell = row.cells[1]; // 2nd column
                // Remove old badge if any and add new one
                const readerName = userEmail.split('@')[0];
                const existingSpan = nameCell.querySelector('span');
                if (existingSpan) existingSpan.remove();
                nameCell.innerHTML += `<span style="color:#9ca3af; font-size:0.8em; display:block;">Lu par ${readerName}</span>`;

                // Update DB
                db.collection("contacts").doc(id).update({
                    read: true,
                    readBy: userEmail,
                    readAt: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(err => console.error(err));
            }

            const content = document.getElementById('msgDetailContent');
            content.innerHTML = `
                <div style="display:grid; grid-template-columns: 100px 1fr; gap: 0.5rem; align-items:center;">
                    <strong style="color:var(--text-muted);">Date :</strong> <span>${date}</span>
                    <strong style="color:var(--text-muted);">De :</strong> <span>${name}</span>
                    <strong style="color:var(--text-muted);">Email :</strong> <a href="mailto:${email}" style="color:var(--primary-color);">${email}</a>
                    <strong style="color:var(--text-muted);">Sujet :</strong> <span>${subject}</span>
                </div>
                <div style="margin-top:1rem; padding:1rem; background:var(--bg-body); border-radius:0.5rem; border:1px solid var(--border-glass); line-height:1.6;">${message}</div>
            `;
            document.getElementById('messageModal').classList.add('open');
        }

        // --- PROJECTS LOGIC ---
        function loadProjects() {
            const tbody = document.getElementById('projectsTableBody');
            tbody.innerHTML = '<tr><td colspan="4">Chargement...</td></tr>';
            db.collection("projects").get().then((snap) => {
                tbody.innerHTML = '';
                if (snap.empty) { tbody.innerHTML = '<tr><td colspan="4">Aucun projet.</td></tr>'; return; }
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const statusLabel = d.status === 'en-cours' ? 'En cours' : 'Termin√©';
                    tbody.innerHTML += `<tr>
                        <td><strong>${d.title}</strong></td>
                        <td><span class="status-badge status-${d.status}">${statusLabel}</span></td>
                        <td>${d.tech || '-'}</td>
                        <td><div class="actions-cell">
                            <button class="action-btn btn-edit" onclick="editProject('${docSnap.id}')"><svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="action-btn btn-delete" onclick="deleteProject('${docSnap.id}')"><svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        </div></td></tr>`;
                });
            });
        }
        function openProjectModal() {
            document.querySelector('#projectModal h2').textContent = 'Ajouter un Projet';
            document.getElementById('projectForm').reset();
            document.getElementById('projectId').value = '';
            document.getElementById('projectModal').classList.add('open');
        }
        function editProject(id) {
            document.querySelector('#projectModal h2').textContent = 'Modifier le Projet';
            db.collection("projects").doc(id).get().then((doc) => {
                if (doc.exists) {
                    const d = doc.data();
                    document.getElementById('projectId').value = doc.id;
                    document.getElementById('projectTitle').value = d.title;
                    document.getElementById('projectStatus').value = d.status;
                    document.getElementById('projectTech').value = d.tech || '';
                    document.getElementById('projectDesc').value = d.description || '';
                    document.getElementById('projectImage').value = d.image || '';
                    document.getElementById('projectModal').classList.add('open');
                }
            });
        }
        // Project Form Submit
        document.getElementById('projectForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('projectId').value;
            const data = {
                title: document.getElementById('projectTitle').value,
                status: document.getElementById('projectStatus').value,
                tech: document.getElementById('projectTech').value,
                description: document.getElementById('projectDesc').value,
                image: document.getElementById('projectImage').value
            };
            const p = id ? db.collection("projects").doc(id).update(data) : db.collection("projects").add(data);
            p.then(() => { closeModal('projectModal'); loadProjects(); }).catch(e => alert("Erreur: " + e.message));
        });
        function deleteProject(id) { if (confirm('Supprimer ?')) db.collection("projects").doc(id).delete().then(loadProjects); }


        // --- TEAM LOGIC ---
        function loadTeam() {
            const tbody = document.getElementById('teamTableBody');
            tbody.innerHTML = '<tr><td colspan="4">Chargement...</td></tr>';
            db.collection("team").get().then((snap) => {
                tbody.innerHTML = '';
                if (snap.empty) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Aucun membre.</td></tr>'; return; }

                // Sort Helper: Bureau > Responsable > Membre
                const sortOrder = { 'bureau': 1, 'responsable': 2, 'membre': 3 };
                const members = [];
                snap.forEach(doc => members.push({ id: doc.id, ...doc.data() }));

                members.sort((a, b) => (sortOrder[a.category] || 99) - (sortOrder[b.category] || 99));

                members.forEach(m => {
                    const catLabels = { 'bureau': 'Bureau', 'responsable': 'Responsable', 'membre': 'Membre' };
                    const imgHtml = m.image ? `<img src="${m.image}" class="member-avatar">` : `<div class="member-avatar" style="display:inline-block; text-align:center; line-height:36px;">üë§</div>`;
                    const linkedinHtml = m.linkedin ? `<a href="${m.linkedin}" target="_blank" style="color:#0a66c2">LinkedIn</a>` : '-';

                    tbody.innerHTML += `<tr>
                        <td>${imgHtml} <strong>${m.name}</strong></td>
                        <td>
                            <span class="status-badge cat-${m.category}">${catLabels[m.category] || m.category}</span>
                            <div style="font-size:0.85em; color:var(--text-muted); margin-top:4px;">${m.role}</div>
                        </td>
                        <td>${linkedinHtml}</td>
                        <td><div class="actions-cell">
                            <button class="action-btn btn-edit" onclick="editTeam('${m.id}')"><svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="action-btn btn-delete" onclick="deleteTeam('${m.id}')"><svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        </div></td></tr>`;
                });
            });
        }

        function openTeamModal() {
            document.querySelector('#teamModal h2').textContent = 'Ajouter un Membre';
            document.getElementById('teamForm').reset();
            document.getElementById('memberId').value = '';
            document.getElementById('teamModal').classList.add('open');
        }

        function editTeam(id) {
            document.querySelector('#teamModal h2').textContent = 'Modifier le Membre';
            db.collection("team").doc(id).get().then((doc) => {
                if (doc.exists) {
                    const d = doc.data();
                    document.getElementById('memberId').value = doc.id;
                    document.getElementById('memberName').value = d.name;
                    document.getElementById('memberCategory').value = d.category || 'membre';
                    document.getElementById('memberRole').value = d.role || '';
                    document.getElementById('memberImage').value = d.image || '';
                    document.getElementById('memberLinkedin').value = d.linkedin || '';
                    document.getElementById('teamModal').classList.add('open');
                }
            });
        }

        document.getElementById('teamForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('memberId').value;
            const data = {
                name: document.getElementById('memberName').value,
                category: document.getElementById('memberCategory').value,
                role: document.getElementById('memberRole').value,
                image: document.getElementById('memberImage').value,
                linkedin: document.getElementById('memberLinkedin').value
            };
            const p = id ? db.collection("team").doc(id).update(data) : db.collection("team").add(data);
            p.then(() => { closeModal('teamModal'); loadTeam(); }).catch(e => alert("Erreur: " + e.message));
        });

        function deleteTeam(id) { if (confirm('Supprimer ce membre ?')) db.collection("team").doc(id).delete().then(loadTeam); }

    </script>
</body>

</html>